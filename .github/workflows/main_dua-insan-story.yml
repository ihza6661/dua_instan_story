name: Build and deploy PHP app to Azure Web App - dua-insan-story

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, dom, curl, zip, gd, intl, bcmath, pdo_mysql, sqlite3
          tools: composer:v2

      - name: Cache Composer
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache/files
          key: composer-${{ runner.os }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            composer-${{ runner.os }}-

      - name: Validate and install PHP dependencies
        run: |
          composer install --no-dev --prefer-dist --no-progress --optimize-autoloader
          composer validate --no-check-publish

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache Node modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
          key: npm-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            npm-${{ runner.os }}-

      - name: Build frontend assets (Vite)
        if: hashFiles('package.json') != ''
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi
          npm run build

      - name: Ensure startup script is executable (if present at repo root)
        run: |
          if [ -f ./startup.sh ]; then chmod +x ./startup.sh; fi

      - name: Prepare deployment package (exclude .env and CI files)
        run: |
          zip -r deploy.zip . \
            -x ".git/*" ".github/*" "node_modules/*" "tests/*" ".env" "*.zip"

      - name: Upload artifact for deployment
        uses: actions/upload-artifact@v4
        with:
          name: php-app
          path: deploy.zip

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read

    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v4
        with:
          name: php-app

      - name: Deploy to Azure Web App
        id: deploy-to-webapp
        uses: azure/webapps-deploy@v3
        with:
          app-name: 'dua-insan-story'
          slot-name: 'production'
          package: 'deploy.zip'
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          post-deployment-action: |
            #!/binbin/bash
            echo "Running post-deployment commands..."
            cd /home/site/wwwroot
            
            echo "Creating .env file..."
            echo "${{ secrets.ENV_FILE }}" > .env
            
            echo "Linking storage..."
            php artisan storage:link
            
            echo "Caching config..."
            php artisan config:cache
            
            echo "Caching routes..."
            php artisan route:cache

            echo "Caching views..."
            php artisan view:cache
            
            echo "Post-deployment commands finished."